"use strict";(self.webpackChunkjsapi_angular_cli=self.webpackChunkjsapi_angular_cli||[]).push([[6782],{37908:(J,z,i)=>{i.r(z),i.d(z,{default:()=>Q});var I=i(15861),A=i(50484),R=i(19939),O=(i(57964),i(14007),i(4703),i(51172)),M=i(79412),V=(i(1535),i(57678),i(10141)),l=i(657),u=i(43814),f=i(35935),y=i(43101),T=i(29735),D=i(9811),F=i(85248),v=i(84360),b=i(72260),Z=i(5863);class X{constructor(e){this._remoteClient=e,this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}destroy(){}fetchResource(e,r){var s=this;return(0,I.Z)(function*(){const a=s._resourceMap,n=a.get(e);if(n)return n;let o=s._inFlightResourceMap.get(e);if(o)return o;try{o=s._remoteClient.invoke("tileRenderer.fetchResource",{url:e},{...r}),s._inFlightResourceMap.set(e,o),o.then(c=>(s._inFlightResourceMap.delete(e),a.set(e,c),c))}catch(c){return(0,M.D_)(c)?null:{width:0,height:0}}return o})()}getResource(e){return this._resourceMap.get(e)??null}loadFont(e){return Promise.resolve(null)}}function N(t,e){return(!t.minScale||t.minScale>=e-e/4)&&(!t.maxScale||t.maxScale<=e+e/2)}function G(t){const e=t.message,r={message:{data:{},tileKey:e.tileKey,tileKeyOrigin:e.tileKeyOrigin,version:e.version},transferList:new Array};for(const s in e.data){const a=s,n=e.data[a];if(r.message.data[a]=null,null!=n){const o=n.stride,c=n.indices.slice(0),h=n.vertices.slice(0),m=n.records.slice(0),d=n.metrics?.slice(0),p={stride:o,indices:c,vertices:h,records:m,metrics:d};r.transferList.push(c,h,m),r.message.data[a]=p}}return r}let H=class extends Z.Z{constructor(){super(...arguments),this.type="symbol",this._matchers={feature:null,aggregate:null},this._bufferData=new Map,this._bufferIds=new Map}initialize(){this.addHandles([this.tileStore.on("update",this.onTileUpdate.bind(this))]),this._resourceManagerProxy=new X(this.remoteClient)}destroy(){this._resourceManagerProxy.destroy()}get supportsTileUpdates(){return!0}forEachBufferId(t){this._bufferIds.forEach(e=>{e.forEach(t)})}update(t,e){var r=this;return(0,I.Z)(function*(){const s=e.schema.processors[0];if("symbol"!==s.type)return;const a=(0,l.Hg)(r._schema,s);((0,l.uD)(a,"mesh")||(0,l.uD)(a,"target"))&&(t.mesh=!0,t.why?.mesh.push("Symbology changed"),r._schema=s,r._factory=r._createFactory(s),r._factory.update(s,r.tileStore.tileScheme.tileInfo))})()}onTileMessage(t,e,r,s){return(0,M.k_)(s),this._onTileData(t,e,r,s)}onTileClear(t,e){const r={clear:!0,end:e};return this._bufferData.delete(t.key.id),this._bufferIds.delete(t.key.id),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:t.id,data:r})}onTileError(t,e,r){return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:t.id,error:e},{signal:r.signal})}onTileUpdate(t){for(const e of t.removed)this._bufferData.has(e.key.id)&&this._bufferData.delete(e.key.id),this._bufferIds.has(e.key.id)&&this._bufferIds.delete(e.key.id);for(const e of t.added)this._bufferData.forEach(r=>{for(const s of r)s.message.tileKey===e.id&&this._updateTileMesh("append",e,G(s),[],!1,!1,null)})}_addBufferData(t,e){this._bufferData.has(t)||this._bufferData.set(t,[]),this._bufferData.get(t)?.push(G(e))}_createFactory(t){const{geometryType:e,objectIdField:r,fields:s}=this.service,n={geometryType:e,fields:s,spatialReference:u.Z.fromJSON(this.spatialReference)},o=new F.Wr((m,d)=>this.remoteClient.invoke("tileRenderer.getMaterialItems",m,d),this.tileStore.tileScheme.tileInfo),{matcher:c,aggregateMatcher:h}=t.mesh;return this._store=o,this._matchers.feature=(0,v.fL)(c,o,n,this._resourceManagerProxy),this._matchers.aggregate=h?(0,v.fL)(h,o,n,this._resourceManagerProxy):null,new D.j(e,r,o)}_onTileData(t,e,r,s){var a=this;return(0,I.Z)(function*(){(0,M.k_)(s);const{type:n,addOrUpdate:o,remove:c,clear:h,end:m}=e,d=!!a._schema.mesh.sortKey;if(!o)return a.remoteClient.invoke("tileRenderer.onTileData",{tileKey:t.id,data:{type:n,addOrUpdate:null,remove:c,clear:h,end:m,sort:d}},s);const p=a._processFeatures(t,o,r,s,e.status?.version);try{const S=yield p;if(null==S)return a.remoteClient.invoke("tileRenderer.onTileData",{tileKey:t.id,data:{type:n,addOrUpdate:null,remove:c,clear:h,end:m,sort:d}},s);const x=[];for(const g of S){let K=!1;const L=g.message.bufferIds,C=t.key.id,U=g.message.tileKey;if(C!==U&&null!=L){if(!a.tileStore.get(U)){a._addBufferData(C,g),x.push(g);continue}let E=a._bufferIds.get(U);E||(E=new Set,a._bufferIds.set(U,E));const Y=Array.from(L);for(const w of Y){if(E.has(w)){K=!0;break}E.add(w)}}K||(a._addBufferData(C,g),x.push(g))}yield Promise.all(x.map(g=>{const K=t.key.id===g.message.tileKey;return a._updateTileMesh(n,t,g,K?e.remove:[],K&&e.end,!!e.clear,s.signal)}))}catch(S){a._handleError(t,S,s)}})()}_updateTileMesh(t,e,r,s,a,n,o){var c=this;return(0,I.Z)(function*(){const h=t,m=r.message.tileKey,d=!!c._schema.mesh.sortKey;m!==e.key.id&&(a=!1);const p=r?.message,S={type:h,addOrUpdate:p,remove:s,clear:n,end:a,sort:d},x={transferList:r?.transferList??[],signal:o};return(0,M.k_)(x),c.remoteClient.invoke("tileRenderer.onTileData",{tileKey:m,data:S},x)})()}_processFeatures(t,e,r,s,a){var n=this;return(0,I.Z)(function*(){if(null==e||!e.hasFeatures)return null;const o={transform:t.transform,hasZ:!1,hasM:!1},c=n._factory,h={viewingMode:"",scale:t.scale},m=yield n._matchers.feature,d=yield n._matchers.aggregate;(0,M.k_)(s);const p=n._getLabelInfos(t,e);return yield c.analyze(e.getCursor(),n._resourceManagerProxy,m,d,o,h),(0,M.k_)(s),n._writeFeatureSet(t,e,o,p,c,r,a)})()}_writeFeatureSet(t,e,r,s,a,n,o){const c=e.getSize(),h=this._schema.mesh.matcher.symbologyType,m=new T._(t.key.id,{features:c,records:c,metrics:0},h,n,h!==y.mD.HEATMAP,o),d={viewingMode:"",scale:t.scale},p=e.getCursor();for(;p.next();)try{const x=p.getDisplayId(),g=null!=s?s.get(x):null;a.writeCursor(m,p,r,d,t.level,g,this._resourceManagerProxy)}catch{}return m.serialize(t.tileInfoView.tileInfo.isWrappable)}_handleError(t,e,r){return(0,M.D_)(e)?Promise.resolve():this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:t.id,error:e.message},{signal:r.signal})}_getLabelingSchemaForScale(t){const e=this._schema.mesh.labels;if(null==e)return null;if("subtype"===e.type){const s={type:"subtype",classes:{}};let a=!1;for(const n in e.classes){const o=e.classes[n].filter(c=>N(c,t.scale));a=a||!!o.length,s.classes[n]=o}return a?s:null}const r=e.classes.filter(s=>N(s,t.scale));return r.length?{type:"simple",classes:r}:null}_getLabels(t,e){if("subtype"===e.type){const r=this.service.subtypeField;(0,O.O3)(r,"Expected to find subtype Field");const s=t.readAttribute(r);return null==s?[]:e.classes[s]??[]}return e.classes}_getLabelInfos(t,e){const r=this._getLabelingSchemaForScale(t);if(null==r)return null;const s=new Map,a=e.getCursor();for(;a.next();){const n=a.getDisplayId(),o=[],c=(0,f.nE)(n),h=c&&1!==a.readAttribute("cluster_count")?"aggregate":"feature",m=this._getLabels(a,r);for(const d of m){if(d.target!==h)continue;const S=a.getStorage().getComputedStringAtIndex(c&&"feature"===h?a.readAttribute("referenceId"):n,d.fieldIndex);if(!S)continue;const x=(0,R.E)(S.toString()),K=x[1];this._store.getMosaicItem(d.symbol,(0,b._)(x[0])).then(L=>{o[d.index]={glyphs:L.glyphMosaicItems??[],rtl:K,index:d.index}})}s.set(n,o)}return s}};H=(0,A._)([(0,V.j)("esri.views.2d.layers.features.processors.SymbolProcessor")],H);const Q=H},4959:(J,z,i)=>{i.d(z,{x:()=>V,B:()=>k});var I=i(15861),A=i(90693),R=i(43101),W=i(10827);const j={marker:R.LW.MARKER,fill:R.LW.FILL,line:R.LW.LINE,text:R.LW.TEXT};class B{constructor(u,f,y,T){const D={minScale:f?.minScale,maxScale:f?.maxScale},F=function O(l){return l.minScale||l.maxScale?l.minScale+"-"+l.maxScale:""}(D);this.layers=u,this.data=f,this.hash=this._createHash()+F,this.rendererKey=y;const v={isOutline:!1,placement:null,symbologyType:R.mD.DEFAULT,vvFlags:y};for(const b of u){const Z=j[b.type];v.isOutline="line"===b.type&&b.isOutline,b.materialKey=(0,W.jj)(Z,v),b.maxVVSize=T,b.scaleInfo=D,b.templateHash+=F}}get type(){return"expanded-cim"}_createHash(){let u="";for(const f of this.layers)u+=f.templateHash;return u}}const M=function(){var l=(0,I.Z)(function*(u,f,y){const T=new A._(y,f);return new B(yield T.analyzeSymbolReference(u.data,!1),u.data,u.rendererKey,u.maxVVSize)});return function(f,y,T){return l.apply(this,arguments)}}();function k(l,u,f,y){return P.apply(this,arguments)}function P(){return(P=(0,I.Z)(function*(l,u,f,y){if(!l)return null;if("cim"===l.type)return M(l,u,f);if("web-style"===l.type){const{fetchCIMSymbolReference:T}=yield i.e(9610).then(i.bind(i,99610)),D={type:"cim",data:(yield T(l,null,y))??void 0,rendererKey:l.rendererKey,maxVVSize:l.maxVVSize};return M(D,u,f)}return l})).apply(this,arguments)}function V(l){if(!l)return null;const{avoidSDFRasterization:u,type:f,cim:y,url:T,materialHash:D,maxVVSize:F}=l,v={cim:y,type:f,mosaicHash:D,url:T,size:null,dashTemplate:null,path:null,text:null,fontName:null,animatedSymbolProperties:null,avoidSDFRasterization:u};switch(f){case"marker":F&&"size"in y&&(y.size=Math.max(F,y.size)),v.size=l.size,v.path=l.path,v.animatedSymbolProperties=l.animatedSymbolProperties;break;case"line":v.dashTemplate=l.dashTemplate;break;case"text":v.text=l.text,v.fontName=l.fontName}return v}}}]);